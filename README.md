# LINE Bot 專案

## 概述
基於 Node.js 的 LINE Bot 應用程式，支援雙 webhook（sxi-bot 和 fas-bot），使用 Docker 運行並通過 Nginx 代理管理器進行 SSL 終止。新增了對話管理功能，包括對話記錄查詢、對話內容分析等。

## 功能特點
- 支援雙 LINE Bot 與獨立 webhook
  - `/webhook1`: sxi-bot
  - `/webhook2`: fas-bot
- 通過 Let's Encrypt 實現 SSL/TLS 加密
- Docker 容器化部署
- Nginx 反向代理
- 健康檢查監控
- 管理介面
  - 規則管理與即時預覽
  - 配置自動保存
  - 友善的使用者提示
- 對話管理功能
  - 對話記錄查詢
  - 對話內容分析

## 前置需求
- Docker 和 Docker Compose
- Node.js
- Nginx 代理管理器
- LINE 開發者帳號
- 已配置 DNS 的網域名稱

## 安裝步驟
1. 克隆儲存庫
```bash
git clone [你的儲存庫網址]
cd linebot
```

2. 建立環境檔案
```bash
cp .env.example .env
# 編輯 .env 並填入你的 LINE channel 憑證
```

3. 建構並啟動容器
```bash
docker-compose up -d
```

## 配置說明
- 為你的網域配置 Nginx 代理管理器
- 通過 Let's Encrypt 設置 SSL 憑證
- 在 LINE 開發者控制台配置 webhook 網址：
  - 主要： https://[你的網域]/webhook1
  - 次要： https://[你的網域]/webhook2

## 開發指南
```bash
# 安裝依賴
npm install

# 啟動開發伺服器
npm run dev

# 執行測試
npm test

# 建構生產版本
npm run build
```

## 專案結構
```
linebot/
├── admin/              # 管理介面
│   ├── components/     # UI 組件
│   ├── api.js         # API 函數
│   └── admin.js       # 管理邏輯
├── webhook/           # Webhook 處理器
│   ├── primary.js    # 主要 Bot
│   └── secondary.js  # 次要 Bot
├── config/           # 配置檔案
├── test/            # 測試檔案
└── app.js          # 主應用程式
```

## 環境變數
```
LINE_CHANNEL_ACCESS_TOKEN=你的主要頻道存取權杖
LINE_CHANNEL_SECRET=你的主要頻道密鑰
LINE_CHANNEL_ACCESS_TOKEN_2=你的次要頻道存取權杖
LINE_CHANNEL_SECRET_2=你的次要頻道密鑰
PORT=80
NODE_ENV=production
```

## API 端點
- `GET /health`: 健康檢查
- `POST /webhook1`: 主要 Bot webhook
- `POST /webhook2`: 次要 Bot webhook
- `GET /admin`: 管理介面
- `GET /admin/api/get-config/:botId`: 獲取 Bot 配置
- `POST /admin/api/save-config/:botId`: 保存 Bot 配置
- `POST /admin/api/test/:botId/:category`: 測試回應

## 管理介面功能
管理介面提供以下功能：

### Bot 選擇
- 切換不同的 Bot 配置
- 顯示當前活動的 Bot

### 類別管理
支援以下回應類別：
1. 產品資訊
2. 價格查詢
3. 運送資訊
4. 促銷活動
5. 一般對話
6. 敏感詞

### 配置管理
每個類別包含兩個主要部分：
1. GPT 設定
2. 回覆規則

#### GPT 設定
1. **提示詞**
   - 設定 GPT 的基本行為
   - 定義類別外，或不確定問題的回應方式

2. **範例**
   - 提供對話範例
   - 該類別中，一些特殊情況的範例

#### 回覆規則
1. **關鍵字**
   - 交由GPT透過語意及意圖判斷關鍵字是否匹配
   - 設定觸發條件，支援多關鍵字匹配

2. **固定回覆**
   - 透過關鍵字觸發要帶入的內容。
   - 例如 動態生成比例設定 0%，這裡的內容將完全一樣的來回覆。
   - 配合關鍵字使用。

3. **動態生成比例**
   - 0%、50%、100%，三個檔位
   - 設定為 0%，將完全按照固定回覆內容。
   - 設定為 100% 將固定回覆內容中的核心內容，生成一條全新的內容。
   - 配合固定回覆使用。

4. **回應風格**
   - 定義回應語氣
   - 可選：專業、親切、少女、幽默
   - 配合動態生成使用。

### 測試功能
- 即時測試訊息回應
- 顯示匹配規則資訊
- 提供回應生成過程

## 系統運作機制

### 訊息處理流程
```
用戶發送訊息 -> LINE Bot接收 -> GPT意圖及語意判斷 -> Bot規則處理 -> LINE API回覆
```

### 1. GPT意圖及語意判斷
- **輸入資料**：
  * 用戶訊息
  * 所有類別的GPT設定（包含提示詞和分類範例）
  * 所有類別的回覆規則（包含關鍵字和回覆內容）

- **判斷結果**（JSON格式）：
  * 最適合的類別（例如：產品、價格、運送等）
  * 語義意圖分析
  * 判斷信心度
  * 關鍵詞判斷結果（處理同義詞或變形詞，如"at5"和"at5s"）
  * 生成內容（如果需要重新生成）

### 2. Bot規則處理流程
1. **敏感詞檢查**：
   * 優先判斷是否為敏感詞
   * 如果是敏感詞，直接忽略訊息不回覆

2. **類別處理**：
   - **有明確類別且關鍵詞匹配**：
     * 根據動態比例決定回覆方式：
       - 0%：完全使用固定回覆，包含標點符號和空格
       - 50%：一半固定內容，一半動態生成
       - 100%：保留核心訊息，完全重新生成
     * 動態生成時（50%或100%）：
       - 使用設定的語言風格
       - 保留核心訊息
       - 重新組織語句

   - **無法明確判斷或無關鍵詞匹配**：
     * 判斷是否為一般對話
     * 如果是一般對話但無法回答（如詢問未知產品AT9）：
       - 使用一般對話類別中設定的預設回覆
       - 例如："已通知小編進行回覆，請稍等。"

### 3. GPT設定重點
- **提示詞**：
  * 定義無法回答時的預設回應
  * 設定各類別的處理邊界
  * 敏感詞的判斷標準

- **分類範例**：
  * 採用QA形式的參考案例
  * 協助GPT理解各類別的範圍
  * 提供特殊情況的處理指引

### 4. 回覆規則重點
- **關鍵字設定**：
  * GPT會進行語意分析，處理同義詞
  * 支援關鍵字的變形識別
  * 判斷用戶真正的意圖

- **動態生成比例**：
  * 0%：完全依照固定回覆
  * 50%：混合固定與生成內容
  * 100%：僅保留核心訊息重新生成

- **語言風格**（僅用於動態生成）：
  * 專業：正式商務風格
  * 親切：溫和友善風格
  * 少女：活潑可愛風格
  * 幽默：輕鬆詼諧風格

## 部署說明
1. 確保所有環境變數正確配置
2. 使用 docker-compose 進行部署
3. 配置 Nginx 代理和 SSL
4. 驗證 webhook 連接

## 維護指南
- 定期檢查日誌
- 監控系統資源
- 更新 SSL 憑證
- 備份配置檔案

## 故障排除
1. 檢查日誌檔案
2. 驗證環境變數
3. 確認網路連接
4. 測試 webhook 端點

## 貢獻指南
1. Fork 專案
2. 建立特性分支
3. 提交變更
4. 發起合併請求

## 授權
MIT 授權
