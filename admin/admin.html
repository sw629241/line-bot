<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Line Bot 管理介面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/admin/styles.css" rel="stylesheet"/>
</head>
<body class="bg-darker text-light">
    <div class="container-fluid">
        <!-- 頁面頭部 -->
        <header class="py-3">
            <h2>Line Bot 管理介面</h2>
        </header>

        <main>
            <!-- Bot 選擇器 -->
            <div id="botSelectorContainer"></div>

            <!-- 類別標籤 -->
            <div id="categoryTabsContainer"></div>

            <!-- 類別內容 -->
            <div class="tab-content" id="categoryContent">
                <!-- 各個類別的面板 -->
                <div class="tab-pane fade show active" id="products" role="tabpanel">
                    <div class="gpt-settings-container"></div>
                    <div class="reply-rules-container"></div>
                    <div class="test-area-container"></div>
                </div>

                <div class="tab-pane fade" id="prices" role="tabpanel">
                    <div class="gpt-settings-container"></div>
                    <div class="reply-rules-container"></div>
                    <div class="test-area-container"></div>
                </div>

                <div class="tab-pane fade" id="shipping" role="tabpanel">
                    <div class="gpt-settings-container"></div>
                    <div class="reply-rules-container"></div>
                    <div class="test-area-container"></div>
                </div>

                <div class="tab-pane fade" id="promotions" role="tabpanel">
                    <div class="gpt-settings-container"></div>
                    <div class="reply-rules-container"></div>
                    <div class="test-area-container"></div>
                </div>

                <div class="tab-pane fade" id="chat" role="tabpanel">
                    <div class="gpt-settings-container"></div>
                    <div class="reply-rules-container"></div>
                    <div class="test-area-container"></div>
                </div>

                <div class="tab-pane fade" id="sensitive" role="tabpanel">
                    <div class="gpt-settings-container"></div>
                    <div class="reply-rules-container"></div>
                    <div class="test-area-container"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript 依賴 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 管理界面腳本，注意加載順序 -->
    <script src="/admin/ui.js"></script>
    <script src="/admin/api.js"></script>
    <script src="/admin/admin.js"></script>
    <script src="/admin/bot.js"></script>
    <script src="/admin/gpt.js"></script>

    <!-- 初始化腳本 -->
    <script>
        // 全局管理對象
        window.admin = {
            currentBot: 'sxi-bot',
            currentCategory: 'products'
        };

        // 加載組件
        async function loadComponent(containerId, componentPath) {
            try {
                const response = await fetch(`/admin/components/${componentPath}`);
                const html = await response.text();
                document.getElementById(containerId).innerHTML = html;
            } catch (error) {
                console.error(`Error loading component ${componentPath}:`, error);
            }
        }

        // 初始化頁面
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('開始初始化...');
                
                // 加載所有組件
                await loadComponent('botSelectorContainer', 'bot-selector.html');
                await loadComponent('categoryTabsContainer', 'category-tabs.html');

                // 加載每個類別的組件
                const categories = ['products', 'prices', 'shipping', 'promotions', 'chat', 'sensitive'];
                for (const category of categories) {
                    const containers = document.querySelectorAll(`#${category} .gpt-settings-container, #${category} .reply-rules-container, #${category} .test-area-container`);
                    containers[0].innerHTML = await (await fetch('/admin/components/gpt-settings.html')).text();
                    containers[1].innerHTML = await (await fetch('/admin/components/reply-rules.html')).text();
                    containers[2].innerHTML = await (await fetch('/admin/components/test-area.html')).text();

                    // 設置特定的 ID
                    const gptPrompt = containers[0].querySelector('.gpt-prompt');
                    const gptExamples = containers[0].querySelector('.gpt-examples');
                    const saveGptBtn = containers[0].querySelector('.save-gpt');
                    const ruleList = containers[1].querySelector('.rule-list');
                    const addRuleBtn = containers[1].querySelector('.add-rule');
                    const saveRulesBtn = containers[1].querySelector('.save-rules');
                    const testInput = containers[2].querySelector('.test-input');
                    const testButton = containers[2].querySelector('.test-button');
                    const testResult = containers[2].querySelector('.test-result');

                    if (gptPrompt) gptPrompt.id = `${category}Prompt`;
                    if (gptExamples) gptExamples.id = `${category}Examples`;
                    if (saveGptBtn) saveGptBtn.id = `save${category.charAt(0).toUpperCase() + category.slice(1)}GPT`;
                    if (ruleList) ruleList.id = `${category}RuleList`;
                    if (addRuleBtn) addRuleBtn.id = `add${category.charAt(0).toUpperCase() + category.slice(1)}Rule`;
                    if (saveRulesBtn) saveRulesBtn.id = `save${category.charAt(0).toUpperCase() + category.slice(1)}Rules`;
                    if (testInput) testInput.id = `${category}TestInput`;
                    if (testButton) testButton.id = `test${category.charAt(0).toUpperCase() + category.slice(1)}`;
                    if (testResult) testResult.id = `${category}TestResult`;
                }

                console.log('組件加載完成');

                // 初始化其他功能
                if (window.gpt && typeof window.gpt.initializeOpenAI === 'function') {
                    await window.gpt.initializeOpenAI();
                    console.log('GPT 初始化完成');
                }

                if (window.bot && typeof window.bot.loadCurrentBot === 'function') {
                    await window.bot.loadCurrentBot();
                    console.log('Bot 配置加載完成');
                }

                if (window.ui && typeof window.ui.setupEventListeners === 'function') {
                    window.ui.setupEventListeners();
                    console.log('事件監聽器設置完成');
                }

                console.log('初始化完成');
            } catch (error) {
                console.error('初始化過程中發生錯誤:', error);
            }
        });
    </script>
</body>
</html>
